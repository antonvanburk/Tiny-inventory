<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiny Texture - AI Inventory</title>
<style>
/* --- CSS voor layout, knoppen, tabel, modal en AI chat --- */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#fbf7ec; min-height:100vh; color:#333; }
.container { max-width:1200px; margin:0 auto; padding:20px; }
.header { display:flex; align-items:center; gap:15px; margin-bottom:30px; color:#264939; }
.header svg { width:90px; height:90px; fill:#264939; }
.header h1 { font-size:2.5rem; }
.header p { font-size:1.1rem; opacity:0.9; }
.main-content { background:#fff; border-radius:20px; padding:30px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
.stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; margin-bottom:30px; }
.stat-card { background:#fbf7ec; padding:20px; border-radius:15px; text-align:center; border:2px solid #e0e0e0; }
.stat-card h3 { font-size:2rem; color:#264939; margin-bottom:5px; }
.stat-card p { color:#666; font-weight:500; }
.controls { display:flex; gap:15px; margin-bottom:30px; flex-wrap:wrap; align-items:center; }
.search-box { flex:1; min-width:200px; position:relative; }
.search-box input { width:100%; padding:12px 40px 12px 15px; border:2px solid #e0e0e0; border-radius:10px; font-size:1rem; }
.search-icon { position:absolute; right:15px; top:50%; transform:translateY(-50%); color:#666; }
.btn { padding:14px 28px; border:none; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer; transition:all 0.3s; display:inline-block; }
.btn-primary { background:#264939; color:white; }
.btn-primary:hover { opacity:0.9; }
.btn-secondary { padding: 4px 8px; border: 2px solid #e0e0e0; border-radius: 10px; background: #f8f9fa; color: #333; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.3s; position: relative; }
.btn-secondary:hover:not(:disabled) { opacity: 0.9; }
.btn-secondary:disabled { cursor: not-allowed; opacity: 0.5; }
.btn-danger { background:#d9534f; color:white; }
.btn-success { background:#28a745; color:white; }
.btn-ai { background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; position:relative; overflow:hidden; }
.btn-ai:hover { transform:translateY(-2px); }
.btn-ai::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition:left 0.5s; }
.btn-ai:hover::before { left:100%; }
.inventory-table { width:100%; border-collapse:collapse; margin-top:20px; background:white; border-radius:15px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
.inventory-table th, .inventory-table td { padding:15px; text-align:left; border-bottom:1px solid #eee; }
.inventory-table th { background:#264939; color:white; font-weight:600; position:sticky; top:0; }
.inventory-table tr:hover { background-color:#f8f9fa; }
.inventory-table .btn-secondary { padding: 4px 8px; font-size: 0.8rem; border-radius: 5px; }
.stock-value { display: inline-block; width: 30px; text-align: center; }
.stock-status { padding:5px 10px; border-radius:20px; font-size:0.85rem; font-weight:600; }
.stock-low { background:#ffe3e3; color:#d63031; }
.stock-medium { background:#fff3cd; color:#856404; }
.stock-high { background:#d4edda; color:#155724; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); overflow-y:auto; }
.modal-content { background-color:white; margin:5% auto; padding:30px; border-radius:20px; width:90%; max-width:500px; position:relative; }
.close { position:absolute; right:20px; top:15px; color:#aaa; font-size:28px; font-weight:bold; cursor:pointer; }
.close:hover { color:#000; }
.form-group { margin-bottom:20px; }
.form-group label { display:block; margin-bottom:8px; font-weight:600; color:#264939; }
.form-group input, .form-group select, .form-group textarea { width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:10px; font-size:1rem; }
.form-group textarea { resize:vertical; min-height:80px; }
.empty-state { text-align:center; padding:50px; color:#666; }
.empty-state div { font-size:4rem; margin-bottom:20px; }
.dropdown { position:relative; display:inline-block; }
.dropdown-content { display:none; position:absolute; background-color:#f8f9fa; min-width:160px; box-shadow:0 8px 16px rgba(0,0,0,0.2); border-radius:10px; z-index:1; }
.dropdown-content button { width:100%; padding:10px; text-align:left; border:none; background:none; cursor:pointer; border-bottom:1px solid #e0e0e0; border-radius:0; }
.dropdown-content button:last-child { border-bottom:none; }
.dropdown:hover .dropdown-content { display:block; }
/* AI Chat Styles */
.ai-chat { position:fixed; bottom:20px; right:20px; z-index:1000; }
.ai-toggle { width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:none; color:white; font-size:24px; cursor:pointer; box-shadow:0 8px 20px rgba(102, 126, 234, 0.3); transition:all 0.3s; animation:pulse 2s infinite; }
.ai-toggle:hover { transform:scale(1.1); }
@keyframes pulse { 0%, 100% { box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); } 50% { box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6); } }
.ai-window { display:none; position:fixed; bottom:100px; right:20px; width:400px; height:500px; background:white; border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden; }
.ai-header { background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px; text-align:center; font-weight:600; }
.ai-messages { height:340px; overflow-y:auto; padding:20px; }
.ai-input-area { padding:20px; border-top:1px solid #eee; }
.ai-input { flex:1; padding:12px; border:2px solid #e0e0e0; border-radius:10px; }
.ai-send { padding:12px 20px; background:#667eea; color:white; border:none; border-radius:10px; cursor:pointer; }
.message { margin-bottom:15px; }
.user-message { text-align:right; }
.user-message .bubble { background:#667eea; color:white; padding:12px 16px; border-radius:18px 18px 5px 18px; display:inline-block; max-width:80%; }
.ai-message .bubble { background:#f0f0f0; padding:12px 16px; border-radius:18px 18px 18px 5px; display:inline-block; max-width:80%; }
.typing-indicator { display:none; }
.typing-indicator .bubble { background:#f0f0f0; padding:16px; border-radius:18px; }
.typing-dots { display:flex; gap:4px; }
.typing-dots span { width:8px; height:8px; border-radius:50%; background:#999; animation:typing 1.4s infinite; }
.typing-dots span:nth-child(2) { animation-delay:0.2s; }
.typing-dots span:nth-child(3) { animation-delay:0.4s; }
@keyframes typing { 0%, 60%, 100% { transform:translateY(0); } 30% { transform:translateY(-10px); } }
.ai-suggestions { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
.suggestion-chip { background:#f8f9fa; border:1px solid #e0e0e0; padding:8px 12px; border-radius:20px; font-size:12px; cursor:pointer; transition:all 0.3s; }
.suggestion-chip:hover { background:#667eea; color:white; }
@media (max-width: 768px) { .ai-window { width:90vw; right:5vw; } }
</style>
</head>
<body>
<div class="container">
<div class="header">
    <div id="logo">
        <svg id="svg" xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 400 400"><g><path fill="#264939" d="M184.738 80.325C176.482 86.046 167.09 92.543 163.867 94.763C160.645 96.982 148.34 105.551 136.523 113.804L115.039 128.811L114.935 139.787L114.832 150.764L117.279 149.083C118.625 148.159 123.442 144.823 127.983 141.67C132.525 138.517 136.348 135.938 136.48 135.938C136.611 135.938 136.719 150.264 136.719 167.773V199.609H145.117H153.516V161.61V123.611L163.965 116.366C169.712 112.381 180.177 105.119 187.22 100.227L200.027 91.334L201.088 92.029C201.671 92.411 209.971 98.164 219.531 104.814C229.092 111.464 239.067 118.398 241.699 120.223L246.484 123.541V161.575V199.609H254.883H263.281V167.773C263.281 150.264 263.388 135.938 263.518 135.938C263.648 135.938 266.328 137.752 269.475 139.969C272.621 142.187 277.437 145.539 280.176 147.418L285.156 150.834V139.931C285.156 130.033 285.093 128.973 284.473 128.434C283.694 127.758 252.488 106.039 211.793 77.852C205.496 73.49 200.21 69.922 200.047 69.922C199.883 69.922 192.994 74.603 184.738 80.325M197.239 115.238C180.918 118.001 182.43 142.6 198.986 143.662C216.91 144.813 220.036 118.59 202.374 115.24C200.066 114.802 199.811 114.802 197.239 115.238M191.406 177.344V199.609H199.805H208.203V177.344V155.078H199.805H191.406V177.344"></path></g></svg>
    </div>
    <div>
        <h1>Tiny Texture</h1>
        <p>AI-Powered Inventory</p>
    </div>
</div>
<div class="main-content">
    <div class="stats">
        <div class="stat-card"><h3 id="totalItems">0</h3><p>Totaal Items</p></div>
        <div class="stat-card"><h3 id="totalValue">‚Ç¨0.00</h3><p>Totale Waarde</p></div>
        <div class="stat-card"><h3 id="lowStock">0</h3><p>Lage Voorraad</p></div>
    </div>
    <div class="controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Zoek items..." oninput="renderInventory()">
            <span class="search-icon">üîç</span>
        </div>
        <button class="btn btn-primary" onclick="openModal()">‚ûï Nieuw Item</button>
        <div class="dropdown">
            <button class="btn btn-secondary">‚¨áÔ∏è Import/Export</button>
            <div class="dropdown-content">
                <button onclick="exportCSV()">Exporteer CSV</button>
                <button onclick="exportJSON()">Exporteer JSON</button>
                <button onclick="document.getElementById('importFile').click()">Importeer CSV/JSON</button>
            </div>
        </div>
        <input type="file" id="importFile" style="display:none" accept=".json,.csv">
        <select id="categoryFilter" class="btn btn-secondary" onchange="renderInventory()"><option value="">Alle Categorie√´n</option></select>
        <select id="statusFilter" class="btn btn-secondary" onchange="renderInventory()">
            <option value="">Alle Statussen</option>
            <option value="Hoog">Hoog</option>
            <option value="Middel">Middel</option>
            <option value="Laag">Laag</option>
        </select>
    </div>
    <table class="inventory-table" id="inventoryTable" style="display:none;">
        <thead>
            <tr>
                <th>Code</th><th>Naam</th><th>Categorie</th><th>Voorraad</th><th>Min. Voorraad</th><th>Prijs</th><th>Locatie</th><th>Status</th><th>Acties</th>
            </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
    </table>
    <div id="emptyState" class="empty-state" style="display:block;">
        <div>üì¶</div>
        <h3>Geen items gevonden</h3>
        <button class="btn btn-primary" onclick="openModal()">‚ûï Voeg een item toe</button>
    </div>
</div>
<div id="itemModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Nieuw Item</h2>
        <form id="itemForm" onsubmit="saveItem(event)">
            <div class="form-group">
                <label for="itemCode">Code</label>
                <input type="text" id="itemCode" name="itemCode" required>
            </div>
            <div class="form-group">
                <label for="itemName">Naam</label>
                <input type="text" id="itemName" name="itemName" required>
            </div>
            <div class="form-group">
                <label for="category">Categorie</label>
                <select id="category" name="category"></select>
            </div>
            <div class="form-group">
                <label for="stock">Voorraad</label>
                <input type="number" id="stock" name="stock" required min="0" value="0">
            </div>
            <div class="form-group">
                <label for="minStock">Minimale Voorraad</label>
                <input type="number" id="minStock" name="minStock" required min="0" value="0">
            </div>
            <div class="form-group">
                <label for="price">Prijs</label>
                <input type="number" id="price" name="price" required min="0" step="0.01" value="0.00">
            </div>
            <div class="form-group">
                <label for="location">Locatie</label>
                <input type="text" id="location" name="location">
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Opslaan</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuleren</button>
            </div>
        </form>
    </div>
</div>
<div class="ai-chat">
    <button class="ai-toggle" onclick="toggleAI()">ü§ñ</button>
    <div class="ai-window" id="aiWindow">
        <div class="ai-header">AI Assistent</div>
        <div class="ai-messages" id="aiMessages"></div>
        <div class="ai-input-area">
            <div class="ai-suggestions">
                <span class="suggestion-chip" onclick="sendSuggestion('Wat is de totale waarde van de inventaris?')">Totale waarde</span>
                <span class="suggestion-chip" onclick="sendSuggestion('Toon alle items met lage voorraad')">Lage voorraad</span>
                <span class="suggestion-chip" onclick="sendSuggestion('Voeg een item toe')">Nieuw item</span>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" class="ai-input" id="aiInput" placeholder="Typ iets..." onkeydown="if(event.key==='Enter'){sendAI()}">
                <button class="ai-send" onclick="sendAI()">Verstuur</button>
            </div>
        </div>
    </div>
</div>
<script>
// --- GLOBAL STATE ---
let inventory = [];
let editIndex = null;
const fixedCategories = ["Decoratie", "Filament", "Overig", "Promotie Materiaal", "Reserve Onderdelen", "Waxinelichthuisjes", "Waxinelichtjes"];
const customCategoriesKey = 'customCategories';

// --- UTILITY FUNCTIONS ---
function saveInventory() {
    localStorage.setItem('inventory', JSON.stringify(inventory));
}

function loadInventory() {
    const storedInventory = localStorage.getItem('inventory');
    if (storedInventory) {
        inventory = JSON.parse(storedInventory);
    }
}

// --- CATEGORY FUNCTIONS ---
function getCombinedCategories() {
    const customCategories = JSON.parse(localStorage.getItem(customCategoriesKey)) || [];
    const combined = [...new Set([...fixedCategories, ...customCategories])].sort();
    return combined;
}

function updateCategoryDropdown(selectId) {
    const select = document.getElementById(selectId);
    const categories = getCombinedCategories();
    select.innerHTML = '';
    
    if (selectId === 'categoryFilter') {
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Alle Categorie√´n';
        select.appendChild(defaultOption);
    }
    
    categories.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        select.appendChild(option);
    });

    const newCategoryOption = document.createElement('option');
    newCategoryOption.value = 'addNewCategory';
    newCategoryOption.textContent = '‚ûï Nieuwe Categorie Toevoegen';
    select.appendChild(newCategoryOption);

    const deleteCategoryOption = document.createElement('option');
    deleteCategoryOption.value = 'deleteCategory';
    deleteCategoryOption.textContent = 'üóëÔ∏è Categorie Verwijderen';
    select.appendChild(deleteCategoryOption);
}

function addNewCategory() {
    const newCat = prompt("Voer de naam van de nieuwe categorie in:");
    if (newCat && newCat.trim() !== '') {
        const customCategories = JSON.parse(localStorage.getItem(customCategoriesKey)) || [];
        const cleanNewCat = newCat.trim();
        if (!getCombinedCategories().includes(cleanNewCat)) {
            customCategories.push(cleanNewCat);
            localStorage.setItem(customCategoriesKey, JSON.stringify(customCategories));
            updateCategoryDropdown('category');
            updateCategoryDropdown('categoryFilter');
            alert(`Categorie "${cleanNewCat}" toegevoegd.`);
        } else {
            alert(`Categorie "${cleanNewCat}" bestaat al.`);
        }
    }
}

function deleteCategory() {
    const customCategories = JSON.parse(localStorage.getItem(customCategoriesKey)) || [];
    if (customCategories.length === 0) {
        alert("Er zijn geen aangepaste categorie√´n om te verwijderen.");
        return;
    }

    const categoryToDelete = prompt("Welke categorie wil je verwijderen?\n\nBeschikbare categorie√´n: " + customCategories.join(", "));
    if (categoryToDelete && categoryToDelete.trim() !== '') {
        const cleanCatToDelete = categoryToDelete.trim();
        const index = customCategories.indexOf(cleanCatToDelete);
        if (index > -1) {
            if (confirm(`Weet je zeker dat je de categorie "${cleanCatToDelete}" wilt verwijderen? Items in deze categorie worden verplaatst naar "Overig".`)) {
                customCategories.splice(index, 1);
                localStorage.setItem(customCategoriesKey, JSON.stringify(customCategories));
                
                // Update items in de inventaris
                inventory.forEach(item => {
                    if (item.category === cleanCatToDelete) {
                        item.category = "Overig";
                    }
                });

                saveInventory();
                updateCategoryDropdown('category');
                updateCategoryDropdown('categoryFilter');
                renderInventory();
                alert(`Categorie "${cleanCatToDelete}" is verwijderd.`);
            }
        } else {
            alert(`Categorie "${cleanCatToDelete}" niet gevonden.`);
        }
    }
}

// --- MODAL FUNCTIONS ---
function openModal() {
    updateCategoryDropdown('category');
    document.getElementById('itemModal').style.display = 'block';
    document.getElementById('modalTitle').innerText = editIndex === null ? 'Nieuw Item' : 'Item Bewerken';
    document.getElementById('itemCode').focus();
}

function closeModal() {
    document.getElementById('itemModal').style.display = 'none';
    document.getElementById('itemForm').reset();
    editIndex = null;
}

// --- CORE INVENTORY FUNCTIONS ---
function saveItem(e) {
    e.preventDefault();
    const form = document.getElementById('itemForm');
    const itemCode = form.itemCode.value.trim();
    const itemName = form.itemName.value.trim();
    const isDuplicate = inventory.some((item, index) =>
        item.code.toLowerCase() === itemCode.toLowerCase() && index !== editIndex
    );
    if (isDuplicate) {
        alert('Een item met deze code bestaat al. Kies een unieke code.');
        return;
    }
    const newItem = {
        code: itemCode,
        name: itemName,
        category: form.category.value,
        stock: parseInt(form.stock.value),
        minStock: parseInt(form.minStock.value),
        price: parseFloat(form.price.value),
        location: form.location.value
    };
    if (editIndex !== null) {
        inventory[editIndex] = newItem;
    } else {
        inventory.push(newItem);
    }
    saveInventory();
    closeModal();
    renderInventory();
}

function deleteItem(index) {
    if (confirm('Weet je zeker dat je dit item wilt verwijderen?')) {
        inventory.splice(index, 1);
        saveInventory();
        renderInventory();
    }
}

function changeStock(index, amount) {
    inventory[index].stock = Math.max(0, inventory[index].stock + amount);
    saveInventory();
    renderInventory();
}

function editItem(index) {
    const item = inventory[index];
    const form = document.getElementById('itemForm');
    form.itemCode.value = item.code;
    form.itemName.value = item.name;
    form.stock.value = item.stock;
    form.minStock.value = item.minStock;
    form.price.value = item.price;
    form.location.value = item.location;
    
    updateCategoryDropdown('category');
    form.category.value = item.category;

    editIndex = index;
    openModal();
}

// --- RENDER FUNCTIONS ---
function renderInventory() {
    const tbody = document.getElementById('inventoryBody');
    const table = document.getElementById('inventoryTable');
    const empty = document.getElementById('emptyState');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const filtered = inventory.filter(item => {
        const matchSearch = item.name.toLowerCase().includes(searchTerm) || item.code.toLowerCase().includes(searchTerm);
        const matchCategory = categoryFilter ? item.category === categoryFilter : true;
        const stockStatus = getStockStatus(item.stock, item.minStock);
        const matchStatus = statusFilter ? stockStatus === statusFilter : true;
        return matchSearch && matchCategory && matchStatus;
    });

    if (filtered.length === 0) {
        table.style.display = 'none';
        empty.style.display = 'block';
    } else {
        table.style.display = 'table';
        empty.style.display = 'none';
    }

    const fragment = document.createDocumentFragment();
    filtered.forEach(item => {
        const originalIndex = inventory.findIndex(i => i.code === item.code);
        const stockStatus = getStockStatus(item.stock, item.minStock);
        const statusClass = `stock-${stockStatus.toLowerCase()}`;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.code}</td>
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>
                <button class="btn btn-secondary" onclick="changeStock(${originalIndex},-1)" ${item.stock <= 0 ? 'disabled' : ''}>‚ûñ</button>
                <span class="stock-value">${item.stock}</span>
                <button class="btn btn-secondary" onclick="changeStock(${originalIndex},1)">‚ûï</button>
            </td>
            <td>${item.minStock}</td>
            <td>‚Ç¨${item.price.toFixed(2)}</td>
            <td>${item.location}</td>
            <td><span class="stock-status ${statusClass}">${stockStatus}</span></td>
            <td>
                <button class="btn btn-success" onclick="editItem(${originalIndex})">‚úèÔ∏è</button>
                <button class="btn btn-danger" onclick="deleteItem(${originalIndex})">üóëÔ∏è</button>
            </td>`;
        fragment.appendChild(row);
    });
    tbody.innerHTML = '';
    tbody.appendChild(fragment);
    updateStats();
    updateCategoryFilter();
}

function getStockStatus(stock, minStock) {
    if (stock < minStock) {
        return 'Laag';
    } else if (stock <= minStock * 2) {
        return 'Middel';
    } else {
        return 'Hoog';
    }
}

function updateStats() {
    document.getElementById('totalItems').innerText = inventory.length;
    const totalValue = inventory.reduce((acc, i) => acc + (i.price * i.stock), 0);
    document.getElementById('totalValue').innerText = '‚Ç¨' + totalValue.toFixed(2);
    const lowStockCount = inventory.filter(i => i.stock < i.minStock).length;
    document.getElementById('lowStock').innerText = lowStockCount;
}

function updateCategoryFilter() {
    const categories = getCombinedCategories();
    const catSelect = document.getElementById('categoryFilter');
    const selectedCategory = catSelect.value;
    catSelect.innerHTML = '<option value="">Alle Categorie√´n</option>';
    categories.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        if (c === selectedCategory) {
            option.selected = true;
        }
        catSelect.appendChild(option);
    });

    const newCategoryOption = document.createElement('option');
    newCategoryOption.value = 'addNewCategory';
    newCategoryOption.textContent = '‚ûï Nieuwe Categorie Toevoegen';
    catSelect.appendChild(newCategoryOption);

    const deleteCategoryOption = document.createElement('option');
    deleteCategoryOption.value = 'deleteCategory';
    deleteCategoryOption.textContent = 'üóëÔ∏è Categorie Verwijderen';
    catSelect.appendChild(deleteCategoryOption);
}

// --- IMPORT / EXPORT FUNCTIONS ---
function exportJSON() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventory));
    const a = document.createElement('a');
    a.setAttribute('href', dataStr);
    a.setAttribute('download', 'inventory.json');
    a.click();
}

function exportCSV() {
    if (inventory.length === 0) return;
    const keys = Object.keys(inventory[0]);
    const csv = [keys.map(key => JSON.stringify(key)).join(',')];
    inventory.forEach(item => {
        csv.push(keys.map(k => {
            const val = item[k];
            return JSON.stringify(val);
        }).join(','));
    });
    const dataStr = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv.join('\n'));
    const a = document.createElement('a');
    a.setAttribute('href', dataStr);
    a.setAttribute('download', 'inventory.csv');
    a.click();
}

document.getElementById('importFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
        try {
            if (file.name.endsWith('.json')) {
                inventory = JSON.parse(ev.target.result);
            } else if (file.name.endsWith('.csv')) {
                const text = ev.target.result;
                const rows = text.split('\n').filter(line => line.trim() !== '');
                if (rows.length > 1) {
                    const headers = JSON.parse('[' + rows[0] + ']');
                    inventory = rows.slice(1).map(row => {
                        const values = JSON.parse('[' + row + ']');
                        const item = {};
                        headers.forEach((header, i) => {
                            let value = values[i];
                            if (typeof value === 'string' && !isNaN(parseFloat(value)) && isFinite(value)) {
                                value = Number(value);
                            }
                            item[header] = value;
                        });
                        return item;
                    });
                } else {
                    inventory = [];
                }
            }
            saveInventory();
            renderInventory();
            addMessage('ai', '‚úÖ Gegevens succesvol ge√Ømporteerd!');
        } catch (err) {
            addMessage('ai', '‚ùå Fout bij importeren. Controleer de bestandsindeling.');
            console.error(err);
        }
    };
    reader.readAsText(file);
});

// --- AI CHAT FUNCTIONS ---
function toggleAI() {
    const win = document.getElementById('aiWindow');
    win.style.display = win.style.display === 'block' ? 'none' : 'block';
}

function sendSuggestion(command) {
    addMessage('user', command);
    sendAI(command);
}

function sendAI(input) {
    const aiInput = document.getElementById('aiInput');
    const message = input || aiInput.value;
    if (!message) return;
    addMessage('user', message);
    aiInput.value = '';

    const typingIndicator = document.createElement('div');
    typingIndicator.classList.add('message', 'ai-message', 'typing-indicator');
    typingIndicator.innerHTML = '<div class="bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div>';
    document.getElementById('aiMessages').appendChild(typingIndicator);
    document.getElementById('aiMessages').scrollTop = document.getElementById('aiMessages').scrollHeight;

    fetch('/api/ai', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message, inventory: inventory }),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Netwerkfout, status: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        typingIndicator.remove();
        handleGroqReply(data.reply);
    })
    .catch(error => {
        typingIndicator.remove();
        console.error('Fout bij het versturen van het bericht:', error);
        addMessage('ai', 'Er is een fout opgetreden bij de communicatie met de server.');
    });
}

function handleGroqReply(reply) {
    const aiMessagesContainer = document.getElementById('aiMessages');
    const cleanReply = reply.trim();

    if (cleanReply.includes('TOEVOEGEN:')) {
        try {
            const jsonPart = cleanReply.substring(cleanReply.indexOf('TOEVOEGEN:') + 10).trim();
            const newItemData = JSON.parse(jsonPart);
            const newItem = {
                code: String(newItemData.code),
                name: String(newItemData.naam),
                category: newItemData.categorie || 'Overig',
                stock: parseInt(newItemData.voorraad),
                minStock: parseInt(newItemData.minVoorraad),
                price: parseFloat(newItemData.prijs),
                location: newItemData.locatie || ''
            };
            
            const isDuplicate = inventory.some(i => i.code === newItem.code);
            if (!isDuplicate) {
                inventory.push(newItem);
                saveInventory();
                renderInventory();
                addMessage('ai', `‚úÖ Het item "${newItem.name}" is succesvol toegevoegd aan de inventaris!`);
            } else {
                addMessage('ai', `‚ùå Een item met de code "${newItem.code}" bestaat al en kon niet opnieuw worden toegevoegd.`);
            }
        } catch (error) {
            console.error('Fout bij het parsen van de JSON:', error);
            addMessage('ai', '‚ùå Er is een fout opgetreden bij het verwerken van de AI-respons.');
        }
    } else if (cleanReply.includes('BIJWERKEN:')) {
        try {
            const jsonPart = cleanReply.substring(cleanReply.indexOf('BIJWERKEN:') + 10).trim();
            const updatedItemData = JSON.parse(jsonPart);
            const index = inventory.findIndex(item => item.code === updatedItemData.code);

            if (index !== -1) {
                Object.keys(updatedItemData).forEach(key => {
                    const localKey = key === 'naam' ? 'name' : key === 'voorraad' ? 'stock' : key === 'minVoorraad' ? 'minStock' : key === 'prijs' ? 'price' : key === 'locatie' ? 'location' : key;
                    if (localKey in inventory[index]) {
                        if (localKey === 'stock' || localKey === 'minStock') {
                           inventory[index][localKey] = parseInt(updatedItemData[key]);
                        } else if (localKey === 'price') {
                            inventory[index][localKey] = parseFloat(updatedItemData[key]);
                        } else {
                            inventory[index][localKey] = updatedItemData[key];
                        }
                    }
                });
                
                saveInventory();
                renderInventory();
                addMessage('ai', `‚úÖ Item met code ${updatedItemData.code} is bijgewerkt.`);
            } else {
                addMessage('ai', `‚ùå Item met code ${updatedItemData.code} niet gevonden om bij te werken.`);
            }
        } catch (error) {
            console.error('Fout bij het parsen van de JSON voor bijwerken:', error);
            addMessage('ai', '‚ùå Er is een fout opgetreden bij het verwerken van de bijwerkingsrespons.');
        }
    } else {
        // Algemene catch voor onverwachte antwoorden
        addMessage('ai', cleanReply);
    }
}

function addMessage(sender, text) {
    const container = document.getElementById('aiMessages');
    const div = document.createElement('div');
    div.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
    div.innerHTML = `<div class="bubble">${text}</div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

// --- INITIALIZATION ---
window.onload = function() {
    loadInventory();
    renderInventory();
    document.getElementById('category').addEventListener('change', (event) => {
        if (event.target.value === 'addNewCategory') {
            addNewCategory();
            const firstCategory = getCombinedCategories()[0] || '';
            document.getElementById('category').value = firstCategory;
        } else if (event.target.value === 'deleteCategory') {
            deleteCategory();
            const firstCategory = getCombinedCategories()[0] || '';
            document.getElementById('category').value = firstCategory;
        }
    });
    document.getElementById('categoryFilter').addEventListener('change', (event) => {
        if (event.target.value === 'addNewCategory') {
            addNewCategory();
            event.target.value = '';
            renderInventory();
        } else if (event.target.value === 'deleteCategory') {
            deleteCategory();
            event.target.value = '';
            renderInventory();
        }
    });
};
</script>
</body>
</html>
